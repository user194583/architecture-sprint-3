# Задание 1. Анализ и планирование

### 1. Описание функциональности монолитного приложения

**Авторизация:**

- Пользователь регистрируется вручную с привязкой установленных датчиков с ним по номеру телефона администратором системы в БД 
- Пользователь авторизовывается по номеру телефона и вводит код из смс
- Система при успешном вводе кода из СМС начинает сессию с выдачей куки для выполнения запросов

**Управление отоплением:**

- Пользователи могут просматривать список привязанных датчиков и доступные команды для них
- Пользователи могут отправлять команды на включение отопления через браузер на сервер
- Пользователи могут отправлять команды на выключение отопления через браузер на сервер
- Система выдает список привязанных датчиков к пользователю из БД и разрешенные команды для них 
- Система передает команду на включение отопления от сервера датчику
- Система передает команду на выключение отопления от сервера датчику


**Мониторинг температуры:**

- Пользователи могут просмотреть список привязанных датчиков температуры
- Пользователи могут проверять температуру через интернет в браузере
- Система выдает список привязанных датчиов из БД
- Система поддерживает получение данные температуры через запрос датчику от сервера

### 2. Анализ архитектуры монолитного приложения

- База данных Postgresql (1 сервер)
   - таблицы:
       - users
       - devices
       - temps

- Серверный код JAVA Spring 4, ORM Hibernate (1 сервер)
    - Контроллер:
       - GET  / если нет открытой сессии у пользователя редирект на форму логина или отображение страницы навигации
       - GET  /login страница ввода номера телефона
       - POST /login передача номера телефона в форме
       - GET  /code страница ввода кода из СМС
       - POST /code передача кода из СМС
       - GET  /devices список устройств для управления
       - POST /devices/{ID}/on включить отопление
       - POST /devices/{ID}/off выключить отопление
       - GET  /temps список датчиков температуры 
       - GET  /temps/{ID} получить текущее значение температуры

    - Сервис:
       - Авторизация
       - Управление
       - Мониторинг

    - Репозиторий:
       - Пользователи
       - Устройства
       - Датчики

    - Интеграция:
       - Клиент для датчика
       - Клиент для устройства 
       - Клиент для CMC шлюза


Фронт чистый html + CSS с формированием страницы на стороне сервера и при нажатии на кнопку на сервер отправляется запрос на сервер
   1. Форма авторизации для ввода номера телефона 
   2. Форма для ввода кода из СМС
   3. Навигация (Управление, Температура)
   4. Список датчиков с отображением текщего состояния для управления с кнопками с командами для каждого
   5. Список датчиков температуры с текущем значением и с кнопкой обновить показания

Приложение классическое MVC монолитная трехуровневая клиент-серверная архитектура.
Запросы выполняются синхронно с серверной генерацией html страниц с ожиданием ответа и ограничением максимального времени ожидания 30 секунд.
После каждого запроса с командами, производится обновление состояния устройств и значения температур датчиков, c выводом страницы со списком обновленных значений.

Масштабирование возможно только как все приложение целиком на каждом сервере с отдельным экземпляром.

Деплой произволится с выключение приложения на сервере и ручного копирования собранного приложения java+html+css+скрипт кодом на сервер. После окончания копирования, производится миграция базы данных вручную и после запуск приложения.

### 3. Определение доменов и границы контекстов

- Домен "Пользователи"
   - Контекст "Регистрация"
   - Контекст "Авторизация"
   - Контекст "Управление пользователями в системе(Role Administrator)"
      - Добавление
      - Удаление
      - Редактирование информации
      - Блокировка (все устройтва юзера блокируются и задачи отключаются)
      - Разблокировка
- Домен "Устройства (Role Operator)"
   - Контекст "Управление своими устройствами"
      - Добавление
      - Удаление
      - Редактирование информации
      - Список своих устройств
   - Контекст "Команды для своих устройств"
      - Включить отопление
      - Выключить отопление
      - Получить текуший статус устройства
   - Контекст "Мониторинг своих устройств"
      - Включить сбор температуры с датчика (задача) 
      - Выключить сбор температуры с датчика (задача)
- Домен "История (Role Operator, Role Administrator)"
   - Просмотр истории значений полученных от датчиков(температура)
   - Просмотр истории действий пользователя

### **4. Проблемы монолитного решения**

- Пользователи жалуются на частые зависания и ошибки по таймауту
- Деплой приложения вызывает длительную задержку
- При выявлении проблемы в коде приложения после деплоя, невозможен быстрый откат на последнюю рабочую версию
- Регистрация новых пользователй вручную в БД
- Ручное копирование кода и производство SQL запросов вручную при миграции БД, приводили иногда к серьезным проблемам на продуктовой среде
- Привязка устройств к пользователю осуществляется вручную в БД путекм прямых запросв в БД


### 5. Визуализация контекста системы — диаграмма С4

[Контекстная диаграмма С4](docs/context.puml)

[Контекстная диаграмма С4 PNG](docs/context.png)


# Задание 2. Проектирование микросервисной архитектуры

**Диаграмма контейнеров (Containers)**

[Контейнерная диаграмма С4](docs/containers.puml)

[Контейнерная диаграмма C4 PNG](docs/containers.png)

**Диаграмма компонентов (Components)**

[Компонентная диаграмма С4](docs/components.puml)

[Компонентная диаграмма С4 PNG](docs/components.png)

**Диаграмма кода (Code)**

[Компонентная диаграмма С4](docs/code_login.puml)

[Компонентная диаграмма С4 PNG](docs/code_login.png)

# Задание 3. Разработка ER-диаграммы

[ER диаграмма](docs/er_diagram.puml)

[ER диаграмма PNG](docs/er_diagram.png)
